- name: Reporte de Estado de Servicios (Estilo AWX Limpio)
  hosts: lab
  gather_facts: yes
  become: yes

  # --- AÑADE ESTA SECCIÓN ---
  # Esto le dice a Ansible que sea menos estricto con los permisos
  # de los archivos temporales, solucionando el error.
  environment:
    ANSIBLE_ALLOW_WORLD_READABLE_TMPFILES: '1'
  # -------------------------

  vars:
    servicios_a_revisar:
      - sshd.service
      - crond.service
      - firewalld.service
      - zabbix-agent.service
      - traps_pmd.service
      - sssd.service
      - vmtoolsd.service
      - oddjobd.service

  tasks:
    - name: Recolectar estado de todos los servicios
      ansible.builtin.service_facts:

    - name: Generar y mostrar reporte consolidado en consola
      delegate_to: localhost
      run_once: true
      ansible.builtin.shell: |
        echo -e "
        {% for host in ansible_play_hosts_all %}
        --- Reporte de Estado para [{{ host }}] ---\n
          {% for servicio in servicios_a_revisar %}
            {% set srv = hostvars[host].ansible_facts.services.get(servicio) %}
            {% if srv %}
        - {{ '%-25s' | format(servicio) }} | Estado: {{ '%-12s' | format('✅ Activo' if srv.state == 'running' else '❌ Inactivo') }} | Habilitado: {{ '✅ Sí' if srv.status == 'enabled' else 'ℹ️ No' }}\n
            {% else %}
        - {{ '%-25s' | format(servicio) }} | Estado: ❓ No Encontrado\n
            {% endif %}
          {% endfor %}
        \n
        {% endfor %}
        "
      args:
        warn: false
      changed_when: false
